---

- name: bootstrap Arch Linux system
  hosts: localhost
  become: yes
  vars_prompt:
    - name: luks_password
      prompt: "luks password"
      private: yes
      confirm: yes
    - name: install_disk
      prompt: 'Installation target device (e.g. /dev/sda)'
      private: no
    - name: root_password
      prompt: 'root password'
      private: yes
      encrypt: "sha512_crypt"
      confirm: yes
  pre_tasks:
    - set_fact:
        root_password: "{{ root_password }}"
    - name: Update the system clock
      command: timedatectl set-ntp true
  roles:
    - facts
    - os-install


- name: Continue Arch Linux installation in chroot
  hosts: localhost_chroot
  vars:
    boot_mode: "{{ hostvars.localhost.boot_mode }}"
  roles:
    - { role: localisation, tags: 'localisation' }
    - { role: kernel, tags: 'kernel' }
    - { role: network, tags: 'network' }
    - { role: systemd-boot, tags: 'bootloader', when: boot_mode == 'uefi' }
    - { role: syslinux, tags: 'bootloader', when: boot_mode == 'bios' }
    - { role: microcode, tags: 'microcode' }
  tasks:
    - name: Set root password
      user:
        name: root
        password: "{{ hostvars.localhost.root_password }}"

- name: Finish installation
  hosts: localhost
  become: yes
  connection: local
  tasks:
    - name: Unmount partitions
      command: umount -Rf /mnt
      tags: 'cleanup'

    - name: unmount swap
      command: swapoff -a
      tags: 'cleanup'

    - name: close LUKS swap
      luks_device:
        device: "{{ lvm.lv_root.dev }}"
        state: closed
      tags: 'cleanup'

    - name: close LUKS root
      luks_device:
        device: "{{ lvm.lv_swap.dev }}"
        state: closed
      tags: 'cleanup'
